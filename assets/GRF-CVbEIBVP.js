import{L as J,F as K,B as X,a as B,r as M,R as Q,V as Z,S as ee,C as q,P as te,W as ne,O as se,M as Y,b as re,c as oe,d as A,j as p,e as ie,f as ce,J as I,g as ae,h as $,i as H,k as le}from"./index-1_bpcaBg.js";function ue(m){if(typeof TextDecoder<"u")return new TextDecoder().decode(m);let u="";for(let j=0,l=m.length;j<l;j++)u+=String.fromCharCode(m[j]);try{return decodeURIComponent(escape(u))}catch{return u}}class de extends J{constructor(u){super(u),this.propertyNameMapping={}}load(u,j,l,g){const C=this,v=new K(this.manager);v.setPath(this.path),v.setResponseType("arraybuffer"),v.setRequestHeader(this.requestHeader),v.setWithCredentials(this.withCredentials),v.load(u,function(d){try{j(C.parse(d))}catch(_){g?g(_):console.error(_),C.manager.itemError(u)}},l,g)}setPropertyNameMapping(u){this.propertyNameMapping=u}parse(u){function j(e){const s=/ply([\s\S]*)end_header\r?\n/;let n="",r=0;const o=s.exec(e);o!==null&&(n=o[1],r=new Blob([o[0]]).size);const a={comments:[],elements:[],headerLength:r,objInfo:""},y=n.split(`
`);let t;function w(c,i){const f={type:c[0]};return f.type==="list"?(f.name=c[3],f.countType=c[1],f.itemType=c[2]):f.name=c[1],f.name in i&&(f.name=i[f.name]),f}for(let c=0;c<y.length;c++){let i=y[c];if(i=i.trim(),i==="")continue;const f=i.split(/\s+/),F=f.shift();switch(i=f.join(" "),F){case"format":a.format=f[0],a.version=f[1];break;case"comment":a.comments.push(i);break;case"element":t!==void 0&&a.elements.push(t),t={},t.name=f[0],t.count=parseInt(f[1]),t.properties=[];break;case"property":t.properties.push(w(f,D.propertyNameMapping));break;case"obj_info":a.objInfo=i;break;default:console.log("unhandled",F,f)}}return t!==void 0&&a.elements.push(t),a}function l(e,s){switch(s){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}}function g(e,s){const n=s.split(/\s+/),r={};for(let o=0;o<e.length;o++)if(e[o].type==="list"){const a=[],y=l(n.shift(),e[o].countType);for(let t=0;t<y;t++)a.push(l(n.shift(),e[o].itemType));r[e[o].name]=a}else r[e[o].name]=l(n.shift(),e[o].type);return r}function C(e,s){const n={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[]};let r;const o=/end_header\s([\s\S]*)$/;let a="";(r=o.exec(e))!==null&&(a=r[1]);const y=a.split(`
`);let t=0,w=0;for(let c=0;c<y.length;c++){let i=y[c];if(i=i.trim(),i==="")continue;w>=s.elements[t].count&&(t++,w=0);const f=g(s.elements[t].properties,i);d(n,s.elements[t].name,f),w++}return v(n)}function v(e){let s=new X;return e.indices.length>0&&s.setIndex(e.indices),s.setAttribute("position",new B(e.vertices,3)),e.normals.length>0&&s.setAttribute("normal",new B(e.normals,3)),e.uvs.length>0&&s.setAttribute("uv",new B(e.uvs,2)),e.colors.length>0&&s.setAttribute("color",new B(e.colors,3)),e.faceVertexUvs.length>0&&(s=s.toNonIndexed(),s.setAttribute("uv",new B(e.faceVertexUvs,2))),s.computeBoundingSphere(),s}function d(e,s,n){if(s==="vertex")e.vertices.push(n.x,n.y,n.z),"nx"in n&&"ny"in n&&"nz"in n&&e.normals.push(n.nx,n.ny,n.nz),"s"in n&&"t"in n&&e.uvs.push(n.s,n.t),"red"in n&&"green"in n&&"blue"in n&&e.colors.push(n.red/255,n.green/255,n.blue/255);else if(s==="face"){const r=n.vertex_indices||n.vertex_index,o=n.texcoord;r.length===3?(e.indices.push(r[0],r[1],r[2]),o&&o.length===6&&(e.faceVertexUvs.push(o[0],o[1]),e.faceVertexUvs.push(o[2],o[3]),e.faceVertexUvs.push(o[4],o[5]))):r.length===4&&(e.indices.push(r[0],r[1],r[3]),e.indices.push(r[1],r[2],r[3]))}}function _(e,s,n,r){switch(n){case"int8":case"char":return[e.getInt8(s),1];case"uint8":case"uchar":return[e.getUint8(s),1];case"int16":case"short":return[e.getInt16(s,r),2];case"uint16":case"ushort":return[e.getUint16(s,r),2];case"int32":case"int":return[e.getInt32(s,r),4];case"uint32":case"uint":return[e.getUint32(s,r),4];case"float32":case"float":return[e.getFloat32(s,r),4];case"float64":case"double":return[e.getFloat64(s,r),8]}}function T(e,s,n,r){const o={};let a,y=0;for(let t=0;t<n.length;t++)if(n[t].type==="list"){const w=[];a=_(e,s+y,n[t].countType,r);const c=a[0];y+=a[1];for(let i=0;i<c;i++)a=_(e,s+y,n[t].itemType,r),w.push(a[0]),y+=a[1];o[n[t].name]=w}else a=_(e,s+y,n[t].type,r),o[n[t].name]=a[0],y+=a[1];return[o,y]}function R(e,s){const n={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[]},r=s.format==="binary_little_endian",o=new DataView(e,s.headerLength);let a,y=0;for(let t=0;t<s.elements.length;t++)for(let w=0;w<s.elements[t].count;w++){a=T(o,y,s.elements[t].properties,r),y+=a[1];const c=a[0];d(n,s.elements[t].name,c)}return v(n)}let S;const D=this;if(u instanceof ArrayBuffer){const e=ue(new Uint8Array(u)),s=j(e);S=s.format==="ascii"?C(e,s):R(u,s)}else S=C(u,j(u));return S}}function O(m){return m*Math.PI/180}function me(m){return m*1e6/.671}function he(m,u,j,l){const g=l.sourceLocation,C=O(l.wind.direction),v=Math.cos(C)*(m-g.x)+Math.sin(C)*(u-g.y);if(v<=0)return 0;const d=Math.tan(O(l.horizontal_opening_angle)),_=l.a_horizontal*Math.pow(d*v,l.b_horizontal)+l.source_half_width,T=Math.tan(O(l.vertical_opening_angle)),R=l.a_vertical*Math.pow(T*v,l.b_vertical),S=-Math.sin(C)*(m-g.x)+Math.cos(C)*(u-g.y),D=Math.exp(-Math.pow(S,2)/(2*_*_)),e=g.z,s=l.max_abl,n=j-e,r=2*R*R+1e-9,o=Math.exp(-Math.pow(n,2)/r)+Math.exp(-Math.pow(n-2*(s-e),2)/r)+Math.exp(-Math.pow(2*e+n,2)/r)+Math.exp(-Math.pow(2*s+n,2)/r),y=2*Math.PI*l.wind.speed*_*R+1e-9,t=l.emissionRate/y*D*o;if(!(!isFinite(t)||t<0))return me(t)}const xe=()=>{const m=M.useRef(null),u=M.useRef(null),j=M.useRef(null),l=M.useRef(null),g=M.useRef(null),C=M.useRef(null),v=M.useRef(null),d=M.useRef(null),[_,T]=M.useState(!1),R=M.useRef([]),[S,D]=M.useState(1.2),[e,s]=M.useState(3),[n,r]=M.useState(270),o=(t,w)=>{const c=Math.min(t/w,1),i=(1-c)*240;return{color:new q(`hsl(${i}, 100%, 50%)`),opacity:c}};M.useEffect(()=>{if(!m.current)return;C.current=new Q,v.current=new Z;const t=new ee;t.background=new q(1184274),u.current=t;const w=new te(75,m.current.clientWidth/m.current.clientHeight,.1,1e3);w.position.z=20,j.current=w;const c=new ne({antialias:!0});c.setSize(m.current.clientWidth,m.current.clientHeight),m.current.appendChild(c.domElement),l.current=c;const i=new se(w,c.domElement);i.enableDamping=!0,i.dampingFactor=.05,i.rotateSpeed=.5;const f=new Y({color:16729156,transparent:!0,opacity:.8}),F=(x,h,b=.5,E=5)=>{const z=h.attributes.position.array;let G=0;for(let L=0;L<z.length;L+=3){const V=new H(z[L],z[L+1],z[L+2]);if(x.distanceTo(V)<=b&&(G++,G>=E))return!0}return!1},P=(x,h)=>{const b=new H;return h.getWorldDirection(b),new H().subVectors(h.position,x).normalize().dot(b.negate())>0},U=x=>{if(!m.current||!C.current||!v.current||!j.current||!g.current)return;const h=m.current.getBoundingClientRect();v.current.x=(x.clientX-h.left)/h.width*2-1,v.current.y=-((x.clientY-h.top)/h.height)*2+1,C.current.setFromCamera(v.current,j.current);const b=C.current.intersectObject(g.current);if(b.length>3){const z=b[3].point;if(!P(z,j.current)){I.dismiss(),I.error("Errore sconosciuto");return}if(!F(z,g.current.geometry,.5,8)){I.dismiss(),I.error("Punto non individuato correttamente, riprovare o selezionare un altro punto");return}d.current&&(t.remove(d.current),d.current.geometry.dispose(),d.current.material instanceof A&&d.current.material.dispose());const L=new ae(.3,16,12),V=new $(L,f);V.position.copy(z),t.add(V),d.current=V,T(!0),I.dismiss(),I.success("Origine dell'emissione posizionata con successo, imposta i parametri e avvia la simulazione")}else I.dismiss(),I.warning("Attenzione clicca un punto sulla scena")};c.domElement.addEventListener("click",U);let k;new de().load("/models/merged2.ply",x=>{x.center();const h=new re({size:.1,vertexColors:!0}),b=new oe(x,h);b.rotation.set(Math.PI/2,Math.PI,Math.PI),t.add(b),g.current=b;const E=()=>{i.update(),c.render(t,w),k=requestAnimationFrame(E)};E()},void 0,x=>{console.error("Error loading PLY:",x)});const N=()=>{if(!m.current||!l.current||!j.current)return;const x=m.current.clientWidth,h=m.current.clientHeight;c.setSize(x,h),w.aspect=x/h,w.updateProjectionMatrix()};return window.addEventListener("resize",N),()=>{var x;window.removeEventListener("resize",N),c.domElement.removeEventListener("click",U),cancelAnimationFrame(k),g.current&&(t.remove(g.current),g.current.geometry.dispose(),g.current.material instanceof A&&g.current.material.dispose(),g.current=null),d.current&&(t.remove(d.current),d.current.geometry.dispose(),d.current.material instanceof A&&d.current.material.dispose(),d.current=null),R.current.forEach(h=>{t.remove(h),h.geometry.dispose(),h.material instanceof A&&h.material.dispose()}),R.current=[],l.current&&(l.current.dispose(),(x=m.current)!=null&&x.contains(l.current.domElement)&&m.current.removeChild(l.current.domElement),l.current=null),j.current=null,u.current=null,C.current=null,v.current=null}},[]);const a=()=>{if(!d.current||!u.current)return;const w=S/1e3*.671/3600,c={sourceLocation:{x:0,y:0,z:0},wind:{speed:e,direction:n},emissionRate:w,source_half_width:.1,max_abl:500,horizontal_opening_angle:20,vertical_opening_angle:12,a_horizontal:1,a_vertical:1,b_horizontal:.9,b_vertical:.9},i=d.current.position.clone();console.log("=== CONFIRMED PLACEMENT ==="),console.log("Final coordinates:",{x:i.x.toFixed(3),y:i.y.toFixed(3),z:i.z.toFixed(3)});const f=new H(i.x,i.y,i.z),F=.01,P=1.5,U=[];let k=0;for(let N=-P;N<P;N+=F)for(let x=-P;x<P;x+=F)for(let h=-P;h<P;h+=F){const b=he(N,x,h,c);if(b>=4){const E=new H(N,x,h).multiplyScalar(12).add(f);U.push({position:E,concentration:b}),b>k&&(k=b)}}console.log(`Max concentration: ${k.toFixed(6)}`);const W=.2;U.forEach(({position:N,concentration:x})=>{const h=new le(W,W,W),b=o(x,k),E=new Y({color:b.color,transparent:!0,opacity:b.opacity}),z=new $(h,E);z.position.copy(N),u.current.add(z),R.current.push(z)})},y=()=>{u.current&&(d.current&&(u.current.remove(d.current),d.current.geometry.dispose(),d.current.material instanceof A&&d.current.material.dispose(),d.current=null,T(!1),console.log("Sphere removed")),R.current.forEach(t=>{u.current.remove(t),t.geometry.dispose(),t.material instanceof A&&t.material.dispose()}),R.current=[])};return p.jsxs("section",{className:"bg-black text-white min-h-screen flex flex-col",children:[p.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[25vh] p-8",children:[p.jsxs("h2",{className:"text-4xl sm:text-5xl font-bold mb-4 text-center",children:["Simulatore di"," ",p.jsx("span",{className:"bg-gradient-to-r from-blue-400 to-green-400 bg-clip-text text-transparent",children:"emissioni."})]}),p.jsx("p",{className:"text-lg text-gray-300 max-w-md text-center",children:"Un nuovo modo di vedere le emissioni."})]}),p.jsx("div",{className:"flex justify-center items-center px-4 sm:px-6",children:p.jsx(ie,{className:"w-full max-w-6xl h-full bg-gray-900 border border-gray-700 rounded-xl shadow-lg sm:m-6",children:p.jsx(ce,{className:"p-0",children:p.jsx("div",{ref:m,className:"w-full sm:w-100 h-[400px] sm:h-[500px] rounded-md overflow-hidden cursor-crosshair",style:{outline:"none"}})})})}),p.jsxs("div",{className:"mt-4 flex  gap-3 items-center justify-center ",children:[p.jsx("button",{onClick:y,className:"px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:!_,children:"Pulisci scena"}),p.jsx("button",{onClick:a,className:"px-6 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium",disabled:!_,children:"Avvia simulazione"})]}),p.jsxs("div",{className:"max-w-4xl mx-auto p-4 gap-4  flex flex-col sm:flex-row items-center content-center mb-10",children:[p.jsxs("div",{children:[p.jsxs("label",{className:"block font-medium text-white1",children:["Portata dell'emissione (L/h): ",p.jsx("b",{children:S.toFixed(2)})]}),p.jsx("input",{type:"range",min:"0.1",max:"10",step:"0.1",value:S,onChange:t=>D(parseFloat(t.target.value)),className:"w-full"})]}),p.jsxs("div",{className:"flex gap-4 ",children:[p.jsxs("div",{children:[p.jsxs("label",{className:"block  font-medium text-white",children:["Velocità del vento (m/s): ",p.jsx("b",{children:e.toFixed(1)})]}),p.jsx("input",{type:"range",min:"0.1",max:"10",step:"0.1",value:e,onChange:t=>s(parseFloat(t.target.value)),className:"w-full"})]}),p.jsxs("div",{children:[p.jsxs("label",{className:"block font-medium text-white",children:["Direzione del vento (°): ",p.jsx("b",{children:n.toFixed(0)})]}),p.jsx("input",{type:"range",min:"0",max:"360",step:"1",value:n,onChange:t=>r(parseFloat(t.target.value)),className:"w-full"})]})]})]})]})};export{xe as GasSimulation};
